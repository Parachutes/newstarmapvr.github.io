<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>StarmapVR | Space</title>
        <script src="packages/aframe-v1.2.0.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
        <script type="text/javascript" src="packages/aframe-meshline-component.min.js"></script>
        <script type="text/javascript" src="components/pointsComponent.js"></script>
        <script type="text/javascript" src="components/Compass.js"></script>
        <script type="text/javascript" src="packages/papaparse.min.js"></script>
        <script type="text/javascript" src="components/Loader.js"></script>
        <script type="text/javascript" src="globalData.js"></script>
        <script type="text/javascript" src="packages/aframe-look-at-component.min.js"></script>
        <script type="text/javascript" src="components/KeyboardControl.js"></script>
        <script type="text/javascript" src="components/Minimap.js"></script>
        <script type="text/javascript" src="packages/dat.gui.min.js"></script>
        <script type="text/javascript" src="components/ControlPanel.js"></script>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script type="text/javascript" src="components/MovementController.js"></script>
        <script type="text/javascript" src="packages/FileSaver.min.js"></script>
    </head>

    <body>

    <div id="theSpinner" class="d-flex justify-content-center" style="height: 100%; align-items: center; background-color: #F4F6F6">
        <div class="spinner-grow m-3" style="background-color: #943126">
        </div>
        <div class="spinner-grow m-3" style="background-color: #0E6655">
        </div>
        <div class="spinner-grow m-3" style="background-color: #21618C">
        </div>
    </div>



<!-- Upload section -->

    <div class="modal modal-fullscreen" id="uploadModal" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title ms-2 fw-light">Upload</h4>
                </div>
                <div class="modal-body" id='uploadModalBody' style="background-color:#F4F6F6">

                    <div class="card card-body shadow">
                        <div class="mb-3">
                            <label for="formFile1" class="form-label">Please Upload Cell Data CSV File</label>
                            <input class="form-control" type="file" id="formFile1">
                        </div>
                    </div>

                    <div class="container" style="height: 15px"></div>
                    <div class="card card-body shadow">
                        <div class="mb-3">
                            <label for="formFile2" class="form-label">Please Upload Trajectory Data CSV File (not compulsory)</label>
                            <input class="form-control" type="file" id="formFile2">
                        </div>
                    </div>

                    <div class="container" style="height: 15px"></div>
                    <div class="card card-body shadow">
                        <div class="mb-3">
                            <label>Please Specify Animation Path (not compulsory)</label><br/>
                            <table class="table order-list ">
                            </table>
                            <button class="btn btn-success" type="button" id="addrow">Add Path</button>
                        </div>
                    </div>


                    <div class="container" style="height: 15px"></div>
                    <div class="card card-body shadow">
                        <div class="mb-3">
                            <label>Please Upload Image (not compulsory)</label><br/>
                            <table class="table order-list-img">
                            </table>
                            <button class="btn btn-success" type="button" id="addrowImg">Add Image</button>
                        </div>
                    </div>

                    <div class="container" style="height: 15px"></div>
                    <div class="card card-body shadow">
                        <div class="mb-3">
                            <label for="formFile3" class="form-label">Please Upload Transformed Data CSV File (not compulsory)</label>
                            <input class="form-control" type="file" id="formFile3">
                        </div>
                    </div>



                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="backIndex()">Return</button>
                    <button type="button" class="btn btn-success" onclick="uploadEnter()">Enter</button>
                </div>
            </div>
        </div>
    </div>






    <div class="modal fade bd-example-modal-lg" id="theModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Help</h5>
                </div>
                <div class="modal-body">
                    <p> Haven't done yet ...  </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="$('#theModal').modal('toggle');">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="animationProgressContainer" class="progress fixed-bottom m-5" style="z-index: 1100; height: 10px; width: 75%; visibility: hidden">
        <div id="animationProgressBar" class="progress-bar bg-info" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
    </div>

    <div class="position-fixed top-0 left-0 p-3" style="z-index: 5">
        <div id="liveToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" data-delay="10000">
            <div class="d-flex">
                <div class="toast-body">
                    Flyover finished.
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <div class="position-fixed top-50 end-0 pe-3" style="z-index: 5; width: 300px">
        <div id="colormapToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
            <div class="toast-header">
                <strong class="me-auto">Colormap Information</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close" onclick="globalData.showColormap=false"></button>
            </div>

            <div class="toast-body" id="colormapToastBody">
                <img src="image/batlowweb.png" class="img-fluid">
                <div style=" height: 22px">
                    <div style="float: left">MIN: 0</div>
                    <div id="colormapMAX" style="float: right"></div>
                </div>
            </div>

            <div class="toast-body" id="colormapToastBodyCategory" style="display: none">
            </div>

        </div>
    </div>









    </body>


    <script type="text/javascript" src="components/Axis.js"></script>

    <script>

        window.URL = window.URL || window.webkitURL;

        let inputPathCounter = 0;
        let inputImgCounter = 0;

        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const target = urlParams.get('target');

        let spinner, environment, sky, container, camera, cursor, axis, compass, loader, keyboard;
        let movementController, controlPanel, loader2, minimap, uploadF1, uploadF2, uploadModal, uploadF3;

        let customImgList = [];
        let customImgCList = [];

        if (target === 'custom') {
            uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
            uploadModal.toggle();

        } else if (target === 's1' || target === 's2' || target === 's3') {
            globalData.inputFile1 = true;
            globalData.inputFile2 = true;
            globalData.inputPath = true;
            globalData.curAnimationPath = globalData.sampleAnimationPath[target];
            render();
        } else if (target === 's4') {
            globalData.inputFile1 = true;
            globalData.inputFile1Trans = true;
            globalData.inputFile1Trans2 = true;
            globalData.inputFile2 = true;
            globalData.inputPath = true;
            globalData.curAnimationPath = globalData.sampleAnimationPath[target];
            globalData.inputSlice = true;
            globalData.startFrom2D = true;
            globalData.showTrajectory = false;
            render();
        }
        else {
            location.href = "index.html";
        }

        function render () {
            spinner = document.getElementById('theSpinner');
            environment = document.createElement('a-entity');
            sky = document.createElement('a-sky');
            sky.setAttribute('color', '#F4F6F6');

            container = document.createElement('a-entity');
            container.setAttribute('position', '0 0 0');

            camera = document.createElement('a-camera');
            camera.setAttribute('id', 'theCamera');
            camera.setAttribute('look-controls');
            camera.setAttribute("wasd-controls", "acceleration: 270; fly: true");

            if (target === 's1') {
                camera.setAttribute("position", "0 0 250");
            } else {
                camera.setAttribute("position", "75 75 350");
            }

            cursor = document.createElement('a-entity');
            cursor.setAttribute('cursor', "rayOrigin:mouse");
            cursor.setAttribute('raycaster', "objects: [data-raycastable]");
            camera.appendChild(cursor);

            fetch('packages/batlow100.txt')
                .then(response => response.text())
                .then(text => {
                    globalData.batlowColormap = text.split("\n");
                })

            axis = new Axis(container);
            axis.renderAxis();

            compass = new Compass(camera, container);

            loader = new Loader(container, 'cellData');
            if (target === 'custom') {
                loader.loadCSV(uploadF1, 'cellData').then(resolve => {
                    globalData.idStr = Object.keys(resolve[0])[0];
                    globalData.cellData = resolve;
                    loader.renderPoints(resolve);
                })
                if (globalData.inputFile1Trans) {
                    globalData.startFrom2D = true;
                    loader.load3DCSV(uploadF3).then(resolve => {
                        globalData.cellData3D = resolve;
                    })
                }
            } else {
                loader.loadCSV('Sample/'+ target +'/input1.csv', 'cellData').then(resolve => {
                    globalData.idStr = Object.keys(resolve[0])[0];
                    globalData.cellData = resolve;
                    loader.renderPoints(resolve);
                })
                if (globalData.inputFile1Trans) {
                    loader.load3DCSV('Sample/'+ target +'/input1Trans.csv').then(resolve => {
                        globalData.cellData3D = resolve;
                    })
                    if (globalData.inputFile1Trans2) {
                        loader.load3DCSV('Sample/'+ target +'/input1Trans2.csv').then(resolve => {
                            globalData.cellData3D2 = resolve;
                        })
                    }
                }
            }

            keyboard = new KeyboardControl(container);
            keyboard.init();
            keyboard.enableKeyboardControl(true);

            movementController = new MovementController();

            if (globalData.inputSlice) {
                if (target === 'custom') {
                    for (let i = 0; i < customImgList.length; i++) {

                        // let slice = document.createElement('a-image');
                        // slice.setAttribute('id', 'slice'+(i+1));
                        // slice.setAttribute('src', customImgList[i]);
                        // slice.setAttribute('height', '150');
                        // slice.setAttribute('width', '150');
                        // slice.setAttribute('position', '75, 75, '+(customImgCList[i]-5));
                        // slice.setAttribute('rotation', '0 0 0');
                        // container.appendChild(slice);

                        // const reader = new FileReader();
                        /// console.log('debug: ', reader.readAsDataURL(customImgList[i]));


                        console.log('debug: ', customImgList[i]);

                        // let slice = document.createElement('a-image');
                        // slice.setAttribute('id', 'slice'+(i+1));
                        // slice.setAttribute('src', "test"+i+".png");
                        // slice.setAttribute('height', '150');
                        // slice.setAttribute('width', '150');
                        // slice.setAttribute('position', '75, 75, '+(customImgCList[i]-5));
                        // slice.setAttribute('rotation', '0 0 0');
                        // container.appendChild(slice);

                        let img = document.createElement("a-image");
                        // img.src = window.URL.createObjectURL(customImgList[i]);
                        img.src = 'Sample/s4/1.png';
                        img.height = '150';
                        img.width = '150';
                        img.posision = '0 0 0';
                        img.rotation = '0 0 0';
                        img.onload = function() {
                            window.URL.revokeObjectURL(this.src);
                        }
                        console.log('debug2: ', img);
                        container.appendChild(img);


                    }
                } else {
                    loadSlice(container, target);
                }

            }

            setTimeout(function (){
                // load the second csv file
                loader2 = new Loader(container, 'trajectory');
                loader2.registerComp();

                let loader2Para;

                if (target === 'custom') {
                    loader2Para = uploadF2;
                } else {
                    if (globalData.inputFile2) {
                        loader2Para = 'Sample/'+ target +'/input2.csv';
                    }
                }


                loader2.loadCSV(loader2Para, 'trajectory').then(function (resolve){
                    if (resolve) {
                        globalData.trajectoryData = resolve;
                        loader2.renderTrajectory(resolve);
                    }

                    // load the minimap
                    if (globalData.inputFile2 && target !== 's4') {
                        minimap = new Minimap(camera);
                        minimap.renderMinimap();
                    }

                    // show the colormapInfo
                    $('#colormapToast').toast('show');
                })

                let scene = document.createElement('a-scene');
                scene.setAttribute('id', "scene");
                scene.appendChild(environment);
                scene.appendChild(container);
                scene.appendChild(camera);

                document.querySelector('body').appendChild(scene);

                $(document).ready(function() {

                    if (target === 'custom'){
                        loader.renderPoints(globalData.cellData, true);

                        console.log('debug: ', customImgList);

                        for (let i = 0; i < customImgList.length; i++) {
                            let img = document.createElement("a-image");
                            let tempSrc = window.URL.createObjectURL(customImgList[i]);

                            img.setAttribute('src', 'Sample/s4/1.png');
                            img.setAttribute('height', '150');
                            img.setAttribute('width', '150');
                            img.setAttribute('position', '75, 75, -5');
                            img.setAttribute('rotation', '0 0 0');


                            console.log('debug2: ', img, '||', tempSrc);
                            container.appendChild(img);

                            // img.onload = function () {
                            //     window.URL.revokeObjectURL(tempSrc);
                            // }
                        }
                    }

                    document.getElementById('trajectory').setAttribute('visible', ''+globalData.showTrajectory);

                    spinner.style.visibility = "hidden";
                    // load the control panel
                    controlPanel = new ControlPanel();
                    controlPanel.init();
                });

            }, 500);


        }

        function loadSlice(container, id) {
            let slice1 = document.createElement('a-image');
            slice1.setAttribute('id', 'slice1');
            slice1.setAttribute('src', 'Sample/'+id+'/1.png');
            slice1.setAttribute('height', '150');
            slice1.setAttribute('width', '150');
            slice1.setAttribute('position', '75, 75, -5');
            slice1.setAttribute('rotation', '0 0 0');
            container.appendChild(slice1);

            let slice2 = document.createElement('a-image');
            slice2.setAttribute('id', 'slice2');
            slice2.setAttribute('src', 'Sample/'+id+'/2.png');
            slice2.setAttribute('height', '150');
            slice2.setAttribute('width', '150');
            slice2.setAttribute('position', '75, 75, 145');
            slice2.setAttribute('rotation', '0 0 0');
            container.appendChild(slice2);

            console.log('debug: ', slice1);

        }





        function uploadEnter() {

            customImgList = [];
            customImgCList = [];

            uploadF1 = document.getElementById('formFile1').files[0];
            uploadF2 = document.getElementById('formFile2').files[0];
            uploadF3 = document.getElementById('formFile3').files[0];

            let inputPath = {}
            for (let i = 0; i < inputPathCounter; i++) {
                let key = document.getElementById('inputPathName'+i).value;
                let value = document.getElementById('inputPath'+i).value;
                if (key !== '' && value !== ''){
                    inputPath[key] = value;
                }
            }

            for (let i = 0; i < inputImgCounter; i++) {
                let img = document.getElementById('inputImg'+i).files[0];
                let imgC = document.getElementById('inputImgC'+i).value;
                if (img && imgC !== '') {
                    if (img.type === 'image/png') {
                        customImgList.push(img);
                        customImgCList.push(imgC);
                    }
                }
            }

            if (uploadF1 !== undefined) {
                globalData.inputFile1 = true;
                if (uploadF2 !== undefined) {
                    globalData.inputFile2 = true;
                    if (inputPathCounter > 0 && Object.keys(inputPath).length > 0) {
                        globalData.curAnimationPath = inputPath;
                        globalData.inputPath = true;
                    }
                }

                if (uploadF3 !== undefined) {
                    globalData.inputFile1Trans = true;
                    globalData.startFrom2D = true;
                }

                if (customImgList.length > 0) {
                    globalData.inputSlice = true;
                }

                render();
                uploadModal.toggle();

            } else {

                alert('No data received');

            }

        }

        function backIndex() {
            location.href = "index.html";
        }

        $(document).ready(function () {

            $("#addrow").on("click", function () {
                var newRow = $("<tr class='row ps-2 pt-2'>");
                var cols = "";

                cols += '<td class="col-3" style="padding: 0">' +
                    '<input type="text" class="form-control" name="name' + inputPathCounter + '" placeholder="Path name" id="inputPathName' + inputPathCounter + '"/>' +
                    '</td>';
                cols += '<td class="col-8" style="padding: 0">' +
                    '<input type="text" class="form-control" name="path' + inputPathCounter + '" placeholder="Checkpoints" id="inputPath' + inputPathCounter + '"/>' +
                    '</td>';

                cols += '<td class="col-1" style="padding: 0"><input type="button" class="ibtnDel btn btn-primary"  value="Delete"></td>';

                newRow.append(cols);
                $("table.order-list").append(newRow);
                inputPathCounter++;
            });
            $("table.order-list").on("click", ".ibtnDel", function (event) {
                $(this).closest("tr").remove();
                inputPathCounter -= 1
                console.log(inputPathCounter, ' path left');
            });


            $("#addrowImg").on("click", function () {
                var newRow = $("<tr class='row ps-2 pt-2'>");
                var cols = "";

                cols += '<td class="col-8" style="padding: 0">' +
                    '<input class="form-control" type="file" id="inputImg' + inputImgCounter + '">' +
                    '</td>';
                cols += '<td class="col-3" style="padding: 0">' +
                    '<input type="text" class="form-control" name="path' + inputImgCounter + '" placeholder="Coordinate on Z-axis" id="inputImgC' + inputImgCounter + '"/>' +
                    '</td>';

                cols += '<td class="col-1" style="padding: 0"><input type="button" class="ibtnDel btn btn-primary"  value="Delete"></td>';

                newRow.append(cols);
                $("table.order-list-img").append(newRow);
                inputImgCounter++;
            });
            $("table.order-list-img").on("click", ".ibtnDel", function (event) {
                $(this).closest("tr").remove();
                inputImgCounter -= 1
                console.log(inputImgCounter, ' img left');
            });

        });

    </script>


    <style>
        html, body {
            height: 100%;
        }

        .btn-primary {
            background-color: #154360 !important;
            border-color: #154360;
        }

        .btn-success {
            background-color: #16A085;
            border-color: #16A085;
        }

        .btn:hover,
        .btn:active,
        .btn:focus,
        .btn:visited{
            background-color: #EB984E !important;
            border-color: #EB984E !important;
        }

        input[type="text"] {
            box-sizing: border-box;
        }
    </style>
</html>
